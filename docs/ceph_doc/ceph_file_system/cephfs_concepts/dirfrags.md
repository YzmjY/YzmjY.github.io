---
title: 目录分片
---

# 配置目录分片

在CephFS中，当一个目录增长的很大或者负载很高时，CephFS会对它进行分片处理。这可以将目录的元数据拆分到元数据池中的多个对象中，也可以让一个目录由多个 MDS 管理。

在正常的操作中，目录分片对用户和管理员是无感的，此处提到的所有配置项都应该保留为默认值。

虽然目录分片机制使得 CephFS 可以处理单个目录下大量条目，但应用程序也应该对创建非常大的目录保持警惕，这是因为 CephFS 客户端在对目录执行 `ls` 等操作时需要加载所有的目录分片，这仍需要消耗大量的资源。

!!! note

    根目录不会被分片。

所有目录在一可是都只有一个分片，初始分片随着目录和负载的增长会被拆分到更多的分片中，这些分片也可以通过合并来减少一个目录的分片数量。

## 拆分和合并

当 MDS 识别到一个目录需要进行拆分时，它不会立即执行该操作，因为拆分目录会导致元数据IO的中断。在执行拆分之前，存在一个短暂的延迟来保证客户端IO的处理，这个延迟时间的大小可以由`mds_bal_fragment_interval`配置项来控制，默认为5s。

拆分完成后，新的目录分片数量是2的整数幂，具体分片数为2的`mds_bal_split_bits`次方，例如，如果该值为2，一个目录分片将被拆分为4个新的目录分片，该值默认设置为3，即一个目录分片会被拆分为8个新的目录分片。

以下各章节介绍了开始拆分或合并的条件。

## 大小阈值
当一个目录分片大小超过`mds_bal_split_size`（默认为10000个目录条目），该目录分片会被拆分。通常，该拆分操作会在`mds_bal_fragment_interval`(默认为5s)之后开始。但如果分片的大小超过拆分大小的`mds_bal_fragment_fast_factor`倍，则会立即开始拆分。（将挂起所有客户端上的元数据IO）。

`mds_bal_fragment_size_max` 是目录分片大小的硬性限制，当达到此限制后，客户端的新建文件操作将返回`ENOSPC`错误。在合理的配置下，普通的目录永远不应该达到次限制，因为早在此之前该目录分片就会被拆分。默认情况下，该值被设置为`mds_bal_split_size`的10倍，即100000个目录条目。增加该值可能会导致元数据池的目录分片对象过大，从而导致OSD无法处理这些对象。

当一个目录分片大小小于`mds_bal_merge_size`（默认为1000个目录条目），该目录分片会被合并。合并操作没有与上述拆分中对应的快速拆分过程：快速拆分用于避免过大的目录分片，合并操作并不会面临这个问题。默认的合并大小为50个目录条目。

## 访问阈值
除了根据目录分片的大小拆分之外，如果目录分片的访问计数值超过阈值，MDS 也会拆分该目录分片。

MDS 分别为目录分片的读取和写入操作维护随时间衰减的负载计数器。负载计数器会基于 `mds_decay_halflife` 配置项指数衰减。

在进行写入操作时，写入负载计数器会增加，并与 `mds_bal_split_wr` 进行比较，如果超过阈值，就会触发拆分。写入操作包括重命名、取消链接和创建这些元数据IO。

相应的 `mds_bal_split_rd` 阈值用于与跟踪 `readdir` 元数据操作的读取负载计数器进行比较。

`mds_bal_split_rd` 和 `mds_bal_split_wr` 配置项表示目录分配被访问的热度阈值，在 MDS 中被度量为 “读/写热度”，与相应的元数据读/写操作的数量密切相关。默认情况下，读取阈值为 25000 次操作，写入阈值为 10000 次操作，即触发拆分所需写入次数为读取次数的 2.5 倍。

目录分配由于达到访问阈值被拆分后，只会在达到大小阈值 (`mds_bal_merge_size`) 后才会进行合并，因此一个突发的访问热点可能会导致目录永远保持碎片状态，除非对某些目录条目的进行`unlink`操作。
