---
date: 2025-03-27
categories:
  - CEPH
draft: false
---

# 元数据缓存 
> 翻译：https://docs.ceph.com/en/latest/cephfs/mdcache/

<!-- more -->

## CEPHFS：分布式元数据缓存
虽然在CEPHFS中，inode关联的文件数据以Rados对象的形式保存在RADOS底座中，客户端可直接访问osd获取数据，但inode对应的元数据和目录信息由MDS管理。MDS充当所有元数据相关操作的媒介，将元数据数据与文件数据分离存储在单独的RADOS池中。
CephFS客户端可以主动向MDS请求权限来获取或更改inode元数据，MDS也可以将inode的权限主动授权给客户端，这里的权限在MDS中意Caps的形式表示，它是一种更为精细和复杂的权限管理机制。
获取Caps的客户端可以缓存或修改对应inode的数据或元数据，当另一个客户端需要访问相同的信息时，MDS会向客户端收回Caps，客户端需要归还Caps并将他在持有Caps期间的修改提交给MDS。
客户端对于Caps的请求通常会成功，但在存在访问竞争或者MDS的内存压力的时候，这些请求可能会被拒绝或回收。当MDS向客户端发送Caps收回请求时，客户端需要尽快归还Caps，否则将会被加入blacklist，在一定时间内无法与CephFS集群通信。
由于元数据的缓存是分布式的，MDS必须非常谨慎的确保客户端之间不会存在冲突。这使得CephFS客户端能够依赖与比NFS更高的缓存一致性，在NFS中，客户端可能会缓存在服务端已经被修改的数据和元数据。

## 客户端元数据请求
当一个客户端需要查询和修改inode的元数据或者操作一个目录时，它有如下两种方式达到目的：
- 向MDS直接发起请求。
- 根据自身的缓存直接处理。
在CEPHFS中，第二种方式只在客户端持有对应的caps时才可能发生。

