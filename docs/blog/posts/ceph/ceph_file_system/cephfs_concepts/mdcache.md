---
date: 2025-03-27
categories:
  - CEPH
draft: false
---

# CEPHFS：分布式元数据缓存
> 本文翻译自：https://docs.ceph.com/en/latest/cephfs/mdcache/

虽然在CEPHFS中，inode关联的文件数据以Rados对象的形式保存在RADOS底座中，客户端可直接访问osd
获取数据，但inode对应的元数据和目录信息由MDS管理。MDS充当所有元数据相关操作的媒介，将元数据数
据与文件数据分离存储在单独的RADOS池中。

CephFS客户端可以主动向MDS请求权限来获取或更改inode元数据，MDS也可以将inode的权限主动授权给
客户端，这里的权限在MDS中意Caps的形式表示，它是一种更为精细和复杂的权限管理机制。

获取Caps的客户端可以缓存或修改对应inode的数据或元数据，当另一个客户端需要访问相同的信息时，MDS
会向客户端收回Caps，客户端需要归还Caps并将他在持有Caps期间的修改提交给MDS。

客户端对于Caps的请求通常会成功，但在存在访问竞争或者MDS的内存压力的时候，这些请求可能会被拒绝
或回收。当MDS向客户端发送Caps收回请求时，客户端需要尽快归还Caps，否则将会被加入blacklist，在
一定时间内无法与CephFS集群通信。

由于元数据的缓存是分布式的，MDS必须非常谨慎的确保客户端之间不会存在冲突。这使得CephFS客户端能
够依赖与比NFS更高的缓存一致性，在NFS中，客户端可能会缓存在服务端已经被修改的数据和元数据。

<!-- more -->

## 客户端元数据请求
当一个客户端需要查询和修改inode的元数据或者操作一个目录时，它有如下两种方式达到目的：
- 向MDS直接发起请求。
- 根据自身的缓存直接处理。
在CEPHFS中，第二种方式只在客户端持有对应的caps时才可能发生。

客户端可以向 MDS 发送简单的请求，以查询或更改某些元数据。MDS对这些请求的回复还可以向客户端授予 
inode 的特定的caps，从而允许它执行后续请求而无需访问 MDS。

客户端还可以直接从 MDS 请求caps，这对于读取或写入文件数据是必需的。

## MDS集群中的分布式锁
当 MDS 想要读取或更改有关 inode 的信息时，它必须为其收集适当的锁。MDS 群集在给定 inode 上可
能具有一系列不同类型的锁，并且每个 MDS 可能具有不相交的锁集。

如果存在与这些锁冲突的未回收的 caps，则MDS必须先撤销这些 caps，然后才能获取锁。一旦存在冲突的
 caps 返回给 MDS，它就可以获取锁并执行后续请求。

在由多个 MDS 提供服务的文件系统上，元数据缓存也分布在集群中的 MDS 之间。对于每个 inode，在任
何给定时间，集群中只有一个 MDS 被视为权威 MDS。更改该 inode 的任何请求都必须由权威 MDS 完成，
但非权威 MDS 可以将请求转发到权威 MDS。

非权威 MDS 还可以获取读取锁，以防止权威 MDS 在锁被删除之前更改数据，以便它们可以向客户端提供 
inode 信息。

inode 的权威 MDS 也会随时间而变化。MDS集群会主动平衡对 inode 缓存的责任。该行为可以通过将某
些子树固定到单个 MDS 来覆盖。



